---
title:  "DUR MDB 최신화" 

categories:
  -  DUR
tags:
  - [DUR]

date: 2024-01-08
last_modified_at: 2024-01-08
---
# <span style="color:#ffd966">맥락</span>
DUR 측에서 제공한 문서에서, 새로운 DB와 인증 파일로 업데이트 하는 N0800 전문이 있다. N0700 전문으로 현재 버전이 최신 버전인지 확인한 다음 최신 버전이 아니라면 N0800을 요청하는 절차로 이어진다. 하지만 문제는 N0800으로 받아온 db가 담긴 zip 파일이 제대로 받아와지지 않는 현상이 있었다.  
Stream 을 이용해 Byte[]로 받아, zip으로 저장한 뒤 압축을 풀었다. 하지만 압축이 풀린 파일의 내용을 출력한 결과 마치 인코딩이 다른 것 같은 전체적인 차이가 있었다. 그래서 DUR 측에 연락을 해보았지만 돌아오는 대답은 "나는 모르오"였다. 인코딩, 디코딩 과정 없이 그냥 Stream 으로 받아서 File.write로 만들면 된다고 전달 받았지만 이미 모두 해보았고, 동작하지 않았다. 

# <span style="color:#ffd966">고민</span>
**1. DUR에서 제공한 broker 파일은 어떻게 저장하는 걸까?**  
  병원마다 브로커 서버를 1개씩 추가해야하는데, 추가할 때 자동으로 DB와 인증 파일을 최신 버전으로 다운받는다. Broker 또한 Java 기반이어서, jar을 Decompiling 하여 코드를 뜯어보았다. 큰 구조는 Java message를 이용하여 여러 서비스가 한 번에 동작하는 구조인 것 같았다. 하지만 나의 실력으로는 주어진 시간 내에 코드를 상세히 이해할 수 없었다.  

**2. Zip File 이 왜 저장되지 않는 걸까.**  
  FileInputStream, ZipInputStream, Base64 decoding, UTF-8, UTF-16, EUC-KR encoding decoding 등 모든 방법을 해보았지만 원하는 내용이 나오지 않았다. 

# <span style="color:#ffd966">결론</span>
내가 가진 모든 방법을 동원해 Spring으로 해결하려 했지만, 동작하지 않아 결국엔 쉘 스크립트와 도커로 Dummy Broker를 생성하면 자동으로 다운되는 최신 버전을 가져오는 방식으로 구현했다. N0800 전문은 백그라운드에서 배치 프로세스로 동작하거나 1년에 1번 인증 파일 업데이트를 위해 동작하므로 시간이 좀 오래 걸려도 문제 없기에 이런 방식으로 구현해내게 되었다.